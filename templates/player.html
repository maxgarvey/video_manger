<video id="vid-{{.Video.ID}}" controls autoplay style="width:100%;height:100%;display:block;object-fit:contain"
  data-video-id="{{.Video.ID}}">
  <source src="/video/{{.Video.ID}}">
  Your browser does not support the video tag.
</video>
<script>
(function () {
  var vid = document.getElementById('vid-{{.Video.ID}}');
  var videoID = '{{.Video.ID}}';
  var saveTimer = null;

  function saveProgress() {
    if (vid.currentTime < 1) return;
    navigator.sendBeacon('/videos/' + videoID + '/progress',
      new URLSearchParams({ position: vid.currentTime }));
  }

  // Restore last position once metadata is loaded.
  fetch('/videos/' + videoID + '/progress')
    .then(function(r){ return r.json(); })
    .then(function(d){
      if (d.position > 1) {
        vid.addEventListener('loadedmetadata', function() {
          vid.currentTime = d.position;
        }, { once: true });
      }
    });

  // Save on pause and before page unload.
  vid.addEventListener('pause', saveProgress);
  window.addEventListener('beforeunload', saveProgress);

  // Save periodically while playing (every 5s).
  vid.addEventListener('play', function() {
    saveTimer = setInterval(saveProgress, 5000);
  });
  vid.addEventListener('pause', function() {
    clearInterval(saveTimer);
  });
})();
</script>

<!-- Out-of-band: populate the info panel overlay -->
<div id="info-panel" hx-swap-oob="true">

  <!-- Rating buttons -->
  <div id="rating-{{.Video.ID}}" style="display:flex;gap:0.4rem;align-items:center">
    <button
      hx-post="/videos/{{.Video.ID}}/rating"
      hx-vals='{"rating": "{{if eq .Video.Rating 1}}0{{else}}1{{end}}"}'
      hx-target="#rating-{{.Video.ID}}"
      hx-swap="outerHTML"
      title="Like"
      style="background:{{if ge .Video.Rating 1}}#2a4a2a{{else}}#2a2a2a{{end}};border:1px solid {{if ge .Video.Rating 1}}#4a9a4a{{else}}#444{{end}};color:{{if ge .Video.Rating 1}}#8f8{{else}}#888{{end}};padding:0.3rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.85rem"
    >üëç{{if ge .Video.Rating 1}} Liked{{end}}</button>
    <button
      hx-post="/videos/{{.Video.ID}}/rating"
      hx-vals='{"rating": "{{if eq .Video.Rating 2}}0{{else}}2{{end}}"}'
      hx-target="#rating-{{.Video.ID}}"
      hx-swap="outerHTML"
      title="Favourite"
      style="background:{{if eq .Video.Rating 2}}#4a3a00{{else}}#2a2a2a{{end}};border:1px solid {{if eq .Video.Rating 2}}#c8a000{{else}}#444{{end}};color:{{if eq .Video.Rating 2}}#fc0{{else}}#888{{end}};padding:0.3rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.85rem"
    >‚≠ê{{if eq .Video.Rating 2}} Fav{{end}}</button>
  </div>

  <!-- Name editor -->
  <div style="display:flex;align-items:center;gap:0.5rem">
    <span id="video-title-{{.Video.ID}}" style="font-weight:bold;font-size:0.95rem;flex-shrink:0">{{.Video.Title}}</span>
    <form hx-put="/videos/{{.Video.ID}}/name" hx-target="#video-title-{{.Video.ID}}" style="display:flex;gap:0.4rem;flex:1">
      <input type="text" name="name" value="{{.Video.DisplayName}}" placeholder="{{.Video.Filename}}"
        style="flex:1;background:#222;border:1px solid #444;color:#eee;padding:0.3rem 0.5rem;border-radius:4px;font-size:0.85rem">
      <button type="submit" style="background:#2a2a2a;border:1px solid #444;color:#eee;padding:0.3rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.8rem">Rename</button>
    </form>
  </div>

  <!-- Tags -->
  <div id="video-tags-{{.Video.ID}}" style="display:flex;flex-wrap:wrap;gap:0.3rem">
    {{range .Tags}}
    <span style="display:inline-flex;align-items:center;gap:0.25rem;background:#333;border:1px solid #555;border-radius:12px;padding:0.2rem 0.5rem;font-size:0.8rem">
      {{.Name}}
      <button hx-delete="/videos/{{$.Video.ID}}/tags/{{.ID}}" hx-target="#video-tags-{{$.Video.ID}}"
        style="background:none;border:none;color:#aaa;cursor:pointer;font-size:0.75rem;padding:0;line-height:1">‚úï</button>
    </span>
    {{else}}
    <span style="color:#555;font-size:0.8rem">No tags</span>
    {{end}}
  </div>

  <!-- Add tag -->
  <form hx-post="/videos/{{.Video.ID}}/tags" hx-target="#video-tags-{{.Video.ID}}" style="display:flex;gap:0.4rem">
    <input type="text" name="tag" placeholder="Add tag..." list="all-tags"
      style="flex:1;background:#222;border:1px solid #444;color:#eee;padding:0.3rem 0.5rem;border-radius:4px;font-size:0.85rem">
    <datalist id="all-tags">
      {{range .AllTags}}<option value="{{.Name}}">{{end}}
    </datalist>
    <button type="submit" style="background:#2a2a2a;border:1px solid #444;color:#eee;padding:0.3rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.8rem">Add</button>
  </form>

  <!-- File metadata ‚Äî loads async so the player opens immediately -->
  <div id="file-meta-{{.Video.ID}}"
       hx-get="/videos/{{.Video.ID}}/metadata"
       hx-trigger="load"></div>

  <!-- Export -->
  <div style="padding-top:0.25rem">
    <form hx-post="/videos/{{.Video.ID}}/export/usb"
          hx-target="#export-status-{{.Video.ID}}"
          hx-indicator="#export-status-{{.Video.ID}}">
      <button type="submit"
        style="background:#2a2a2a;border:1px solid #444;color:#aaa;padding:0.3rem 0.7rem;border-radius:4px;cursor:pointer;font-size:0.8rem"
        title="Transcode to H.264/AAC MP4 (BluRay/USB compatible) and download"
      >üìÄ Export for USB/TV</button>
    </form>
    <div id="export-status-{{.Video.ID}}" style="font-size:0.78rem;color:#666;margin-top:0.3rem"></div>
  </div>

</div>
